#!/usr/bin/env bash
set -euo pipefail

# ─────────────────────────────────────────────────────────────
# ws - Workspace Manager v4 (Zellij-native)
# Manage Zellij sessions with worktree-based tab layouts
# ─────────────────────────────────────────────────────────────

STATE_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/ws"
LAYOUTS_DIR="$STATE_DIR/layouts"
INDEX_FILE="$STATE_DIR/index.json"
CONFIG_FILE="$STATE_DIR/config.json"

# ─────────────────────────────────────────────────────────────
# Helpers
# ─────────────────────────────────────────────────────────────

init_state() {
  mkdir -p "$STATE_DIR" "$LAYOUTS_DIR"
  [[ -f "$INDEX_FILE" ]] || echo '{"workspaces":{},"last_used":""}' > "$INDEX_FILE"
  [[ -f "$CONFIG_FILE" ]] || echo '{}' > "$CONFIG_FILE"
}

# Generate KDL layout file from tabs JSON
# Input: tabs_json = [{"name": "main", "cwd": "/path"}, ...]
generate_kdl_layout() {
  local tabs_json="$1"

  echo "layout {"
  echo "    tab_template name=\"ws-tab\" {"
  echo "        pane"
  echo "        pane size=1 borderless=true {"
  echo "            plugin location=\"zellij:compact-bar\""
  echo "        }"
  echo "    }"
  echo ""
  echo "$tabs_json" | jq -r '.[] | "\(.name)\t\(.cwd)"' | while IFS=$'\t' read -r name cwd; do
    echo "    ws-tab name=\"$name\" cwd=\"$cwd\""
  done
  echo "}"
}

# Check if Zellij session exists
session_exists() {
  local session="$1"
  # Strip ANSI codes and check for session name at start of line
  zellij list-sessions 2>/dev/null | sed 's/\x1b\[[0-9;]*m//g' | grep -q "^$session"
}

# List available repos from wt
list_repos() {
  wt list --format=json 2>/dev/null | jq -r '
    [.[].path | split("/")[-1] | sub("\\.wt$"; "") | sub("\\..*$"; "")] | unique | .[]
  ' | sort
}

# ─────────────────────────────────────────────────────────────
# ws init [--all] [repo|.] - Create workspace from worktrees
# ─────────────────────────────────────────────────────────────
cmd_init() {
  local repo="${1:-}"
  local select_all=false

  # Parse --all flag
  if [[ "$repo" == "--all" ]] || [[ "$repo" == "-a" ]]; then
    select_all=true
    repo="${2:-}"
  fi

  # Handle "." - detect repo from current directory
  if [[ "$repo" == "." ]]; then
    repo=$(git rev-parse --show-toplevel 2>/dev/null | xargs basename | sed 's/\..*$//' || basename "$(pwd)" | sed 's/\..*$//')
  fi

  # If no repo, show picker
  if [[ -z "$repo" ]]; then
    local repos=$(list_repos)
    if [[ -z "$repos" ]]; then
      echo "No worktrees found. Use 'wt' to create some first." >&2
      exit 1
    fi

    if command -v fzf &>/dev/null; then
      repo=$(echo "$repos" | fzf --header="Select repo to initialize")
    elif command -v gum &>/dev/null; then
      repo=$(echo "$repos" | gum filter --placeholder="Select repo...")
    else
      echo "Usage: ws init <repo-name>" >&2
      echo ""
      echo "Available repos:"
      echo "$repos" | sed 's/^/  /'
      exit 1
    fi
    [[ -z "$repo" ]] && exit 0
  fi

  # Get worktrees for this repo
  local worktrees=$(wt list --format=json 2>/dev/null | jq -c --arg repo "$repo" '[.[] | select(.path | test($repo; "i"))]')
  local count=$(echo "$worktrees" | jq 'length')

  if [[ "$count" == "0" ]]; then
    echo "No worktrees found for: $repo" >&2
    echo "Available repos:"
    list_repos | sed 's/^/  /'
    exit 1
  fi

  echo "Found $count worktree(s) for: $repo"

  # Select branches
  local selected_branches
  if [[ "$select_all" == "true" ]]; then
    selected_branches=$(echo "$worktrees" | jq -r '.[].branch')
  elif command -v gum &>/dev/null && [[ "$count" -gt 1 ]]; then
    local branches=$(echo "$worktrees" | jq -r '.[].branch')
    echo ""
    selected_branches=$(echo "$branches" | gum choose --no-limit --header="Select worktrees (space to select):")
    [[ -z "$selected_branches" ]] && exit 0
  elif command -v fzf &>/dev/null && [[ "$count" -gt 1 ]]; then
    local branches=$(echo "$worktrees" | jq -r '.[].branch')
    selected_branches=$(echo "$branches" | fzf --multi --header="Select worktrees (tab to select multiple):")
    [[ -z "$selected_branches" ]] && exit 0
  else
    selected_branches=$(echo "$worktrees" | jq -r '.[].branch')
  fi

  # Build tabs JSON
  local tabs_json="[]"
  while read -r branch; do
    [[ -z "$branch" ]] && continue
    local path=$(echo "$worktrees" | jq -r --arg b "$branch" '.[] | select(.branch == $b) | .path')
    tabs_json=$(echo "$tabs_json" | jq --arg name "$branch" --arg cwd "$path" '. + [{name: $name, cwd: $cwd}]')
  done <<< "$selected_branches"

  # Derive workspace ID
  local first_cwd=$(echo "$tabs_json" | jq -r '.[0].cwd')
  local parent=$(basename "$(dirname "$first_cwd")")
  local name="$repo"
  local ws_id="${parent}/${name}"
  local session_name="${parent}--${name}"

  # Generate layout file
  local layout_dir="$LAYOUTS_DIR/$parent"
  local layout_file="$layout_dir/${name}.kdl"
  mkdir -p "$layout_dir"

  echo "Generating layout: $layout_file"
  generate_kdl_layout "$tabs_json" > "$layout_file"

  # Update index
  local tabs_list=$(echo "$tabs_json" | jq -c '[.[].name]')
  local now=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
  local index=$(cat "$INDEX_FILE")
  index=$(echo "$index" | jq \
    --arg id "$ws_id" \
    --arg name "$name" \
    --arg parent "$parent" \
    --arg session "$session_name" \
    --argjson tabs "$tabs_list" \
    --arg created "$now" \
    '.workspaces[$id] = {name: $name, parent: $parent, session_name: $session, tabs: $tabs, created: $created} | .last_used = $id')
  echo "$index" > "$INDEX_FILE"

  # Check if session already exists
  if session_exists "$session_name"; then
    echo "Session '$session_name' already exists."
    echo ""

    local action
    if command -v gum &>/dev/null; then
      action=$(gum choose --header="What would you like to do?" "Attach to existing session" "Overwrite (kill and recreate)" "Enter new name" "Cancel")
    elif command -v fzf &>/dev/null; then
      action=$(printf "Attach to existing session\nOverwrite (kill and recreate)\nEnter new name\nCancel" | fzf --header="What would you like to do?")
    else
      echo "Options:"
      echo "  1) Attach to existing session"
      echo "  2) Overwrite (kill and recreate)"
      echo "  3) Enter new name"
      echo "  4) Cancel"
      read -r -p "Choose [1-4]: " choice
      case "$choice" in
        1) action="Attach to existing session" ;;
        2) action="Overwrite (kill and recreate)" ;;
        3) action="Enter new name" ;;
        *) action="Cancel" ;;
      esac
    fi

    case "$action" in
      "Attach to existing session")
        echo "Attaching to session: $session_name"
        exec zellij attach "$session_name"
        ;;
      "Overwrite (kill and recreate)")
        echo "Deleting existing session..."
        zellij delete-session "$session_name" 2>/dev/null || true
        echo "Creating new session: $session_name"
        exec zellij --new-session-with-layout "$layout_file" --config ~/.config/zellij/config.kdl --session "$session_name"
        ;;
      "Enter new name")
        local new_name
        if command -v gum &>/dev/null; then
          new_name=$(gum input --placeholder="Enter session name..." --value="$session_name")
        else
          read -r -p "Enter session name: " new_name
        fi
        [[ -z "$new_name" ]] && { echo "Cancelled."; exit 0; }
        session_name="$new_name"
        # Update index with new session name
        local updated_index=$(cat "$INDEX_FILE")
        updated_index=$(echo "$updated_index" | jq --arg id "$ws_id" --arg session "$session_name" '.workspaces[$id].session_name = $session')
        echo "$updated_index" > "$INDEX_FILE"
        echo "Creating session: $session_name"
        exec zellij --new-session-with-layout "$layout_file" --config ~/.config/zellij/config.kdl --session "$session_name"
        ;;
      *)
        echo "Cancelled."
        exit 0
        ;;
    esac
  fi

  # Start new Zellij session
  echo "Starting Zellij session: $session_name"
  echo ""
  exec zellij --new-session-with-layout "$layout_file" --config ~/.config/zellij/config.kdl --session "$session_name"
}

# ─────────────────────────────────────────────────────────────
# ws pick - Interactive workspace picker
# ─────────────────────────────────────────────────────────────
cmd_pick() {
  if [[ ! -f "$INDEX_FILE" ]] || [[ $(jq '.workspaces | length' "$INDEX_FILE") -eq 0 ]]; then
    echo "No saved workspaces. Use 'ws init' to create one."
    return
  fi

  # Check for picker
  if ! command -v fzf &>/dev/null && ! command -v gum &>/dev/null; then
    echo "Neither fzf nor gum installed." >&2
    echo "Install with: brew install fzf  (recommended for preview)"
    echo ""
    cmd_list
    return
  fi

  # Build picker list
  local list_data=""
  while IFS=$'\t' read -r ws_id name parent session tabs_json; do
    local tabs=$(echo "$tabs_json" | jq -r 'join(", ")')
    local status="  "
    if session_exists "$session"; then
      status="* "
    fi
    list_data+="$(printf "%s\t%s%-12s %-20s [%s]" "$ws_id" "$status" "$parent/" "$name" "$tabs")"$'\n'
  done < <(jq -r '.workspaces | to_entries[] | "\(.key)\t\(.value.name)\t\(.value.parent)\t\(.value.session_name)\t\(.value.tabs | @json)"' "$INDEX_FILE")

  list_data="${list_data%$'\n'}"

  if [[ -z "$list_data" ]]; then
    echo "No saved workspaces."
    return
  fi

  local choice
  if command -v fzf &>/dev/null; then
    # FZF picker with preview
    local script_path="$0"
    choice=$(echo "$list_data" | fzf \
      --ansi \
      --with-nth=2.. \
      --delimiter=$'\t' \
      --header="Workspaces (* = running)" \
      --preview="$script_path preview {1}" \
      --preview-window=right:40%:wrap)
  else
    # Fallback to gum
    local display_only=$(echo "$list_data" | cut -f2-)
    local selected=$(echo "$display_only" | gum filter --placeholder="Select workspace...")
    [[ -z "$selected" ]] && return
    choice=$(echo "$list_data" | grep -F "$selected" | head -1)
  fi

  [[ -z "$choice" ]] && return

  local ws_id=$(echo "$choice" | cut -f1)
  local parent=$(dirname "$ws_id")
  local name=$(basename "$ws_id")
  local session_name=$(jq -r --arg id "$ws_id" '.workspaces[$id].session_name' "$INDEX_FILE")
  local layout_file="$LAYOUTS_DIR/$parent/${name}.kdl"

  # Update last_used
  local index=$(cat "$INDEX_FILE")
  echo "$index" | jq --arg id "$ws_id" '.last_used = $id' > "$INDEX_FILE"

  # Attach or create
  if session_exists "$session_name"; then
    echo "Attaching to existing session: $session_name"
    exec zellij attach "$session_name"
  else
    echo "Creating session from layout: $session_name"
    # Use -n to force new session (works even when inside another Zellij session)
    exec zellij --new-session-with-layout "$layout_file" --config ~/.config/zellij/config.kdl --session "$session_name"
  fi
}

# ─────────────────────────────────────────────────────────────
# ws add [path] - Add tab to current Zellij session
# ─────────────────────────────────────────────────────────────
cmd_add() {
  local path="${1:-.}"

  # Must be inside Zellij
  if [[ -z "${ZELLIJ_SESSION_NAME:-}" ]]; then
    echo "Error: Must run from inside a Zellij session" >&2
    echo "Use 'ws init' or 'ws pick' first."
    exit 1
  fi

  # Resolve path
  if [[ "$path" == "." ]]; then
    path="$(pwd)"
  else
    path=$(cd "$path" 2>/dev/null && pwd) || {
      echo "Error: Path not found: $path" >&2
      exit 1
    }
  fi

  local tab_name=$(basename "$path")

  echo "Adding tab: $tab_name"
  echo "  Path: $path"

  zellij action new-tab --name "$tab_name" --cwd "$path"
}

# ─────────────────────────────────────────────────────────────
# ws list - List saved workspaces
# ─────────────────────────────────────────────────────────────
cmd_list() {
  if [[ ! -f "$INDEX_FILE" ]] || [[ $(jq '.workspaces | length' "$INDEX_FILE") -eq 0 ]]; then
    echo "No saved workspaces."
    echo "Use 'ws init' to create one."
    return
  fi

  echo "=== Saved Workspaces ==="
  local current_parent=""

  jq -r '.workspaces | to_entries | sort_by(.value.parent, .value.name) | .[] | "\(.value.parent)\t\(.value.name)\t\(.value.session_name)\t\(.value.tabs | length)"' "$INDEX_FILE" | \
  while IFS=$'\t' read -r parent name session tabs_count; do
    if [[ "$parent" != "$current_parent" ]]; then
      [[ -n "$current_parent" ]] && echo ""
      echo "$parent/"
      current_parent="$parent"
    fi

    local status="  "
    if session_exists "$session"; then
      status="* "
    fi

    printf "  %s%-20s %d tab(s)\n" "$status" "$name" "$tabs_count"
  done

  echo ""
  echo "(* = running session)"
}

# ─────────────────────────────────────────────────────────────
# ws delete <name> - Delete workspace
# ─────────────────────────────────────────────────────────────
cmd_delete() {
  local input="${1:-}"

  if [[ -z "$input" ]]; then
    echo "Usage: ws delete <workspace>" >&2
    exit 1
  fi

  # Resolve to full ID if needed
  local ws_id="$input"
  if [[ "$input" != */* ]]; then
    ws_id=$(jq -r --arg name "$input" '.workspaces | to_entries[] | select(.value.name == $name) | .key' "$INDEX_FILE" | head -1)
  fi

  if [[ -z "$ws_id" ]] || ! jq -e --arg id "$ws_id" '.workspaces[$id]' "$INDEX_FILE" >/dev/null 2>&1; then
    echo "Workspace not found: $input" >&2
    exit 1
  fi

  local parent=$(dirname "$ws_id")
  local name=$(basename "$ws_id")
  local layout_file="$LAYOUTS_DIR/$parent/${name}.kdl"

  # Delete layout file
  [[ -f "$layout_file" ]] && rm "$layout_file"

  # Update index
  local index=$(cat "$INDEX_FILE")
  index=$(echo "$index" | jq --arg id "$ws_id" 'del(.workspaces[$id])')
  echo "$index" > "$INDEX_FILE"

  echo "Deleted workspace: $ws_id"
}

# ─────────────────────────────────────────────────────────────
# ws status - Show current Zellij session info
# ─────────────────────────────────────────────────────────────
cmd_status() {
  if [[ -n "${ZELLIJ_SESSION_NAME:-}" ]]; then
    echo "Current Zellij session: $ZELLIJ_SESSION_NAME"
    echo ""
    echo "Tabs in this session:"
    echo "  (use Ctrl+t to see tabs in Zellij)"
  else
    echo "Not inside a Zellij session."
  fi

  echo ""
  echo "=== All Zellij Sessions ==="
  zellij list-sessions 2>/dev/null | sed 's/^/  /' || echo "  (none)"
}

# ─────────────────────────────────────────────────────────────
# ws preview <ws_id> - FZF preview helper
# ─────────────────────────────────────────────────────────────
cmd_preview() {
  local ws_id="$1"
  local parent=$(dirname "$ws_id")
  local name=$(basename "$ws_id")
  local layout_file="$LAYOUTS_DIR/$parent/${name}.kdl"

  echo "=== $ws_id ==="
  echo ""

  if ! jq -e --arg id "$ws_id" '.workspaces[$id]' "$INDEX_FILE" >/dev/null 2>&1; then
    echo "Workspace not found"
    return
  fi

  local session=$(jq -r --arg id "$ws_id" '.workspaces[$id].session_name' "$INDEX_FILE")
  local tabs=$(jq -r --arg id "$ws_id" '.workspaces[$id].tabs[]' "$INDEX_FILE")

  echo "Session: $session"
  echo ""
  echo "Tabs:"
  echo "$tabs" | sed 's/^/  - /'

  echo ""
  if session_exists "$session"; then
    echo "Status: * Running"
  else
    echo "Status: Not running"
  fi

  if [[ -f "$layout_file" ]]; then
    echo ""
    echo "Layout: $layout_file"
  fi
}

# ─────────────────────────────────────────────────────────────
# Main
# ─────────────────────────────────────────────────────────────
show_usage() {
  cat <<EOF
ws - Workspace Manager v4 (Zellij-native)

Manage Zellij sessions with worktree-based tab layouts.

Usage:
  ws                   Show this help
  ws pick              Interactive picker to attach/create workspace
  ws init [repo|.]     Create workspace from worktrees
  ws init --all [repo|.] Create workspace with ALL worktrees
  ws add [path]        Add tab to current Zellij session
  ws list              List saved workspaces
  ws delete <name>     Delete a workspace
  ws status            Show current Zellij session info

Examples:
  ws pick                      # Pick workspace to attach
  ws init .                    # Create from current repo's worktrees
  ws init --all obsidian       # Create with all worktrees for obsidian
  ws add ~/other/project       # Add new tab to current session

Notes:
  - Zellij handles session persistence automatically
  - Sessions survive terminal close (reattach with 'zellij attach')
  - Use Ctrl+o d to detach from a session
  - Run from any terminal (not tied to Kitty)
EOF
}

init_state

case "${1:-}" in
  "")        show_usage ;;
  pick)      cmd_pick ;;
  init)      shift; cmd_init "$@" ;;
  add)       cmd_add "${2:-.}" ;;
  list)      cmd_list ;;
  delete)    cmd_delete "${2:-}" ;;
  status)    cmd_status ;;
  preview)   cmd_preview "${2:-}" ;;
  -h|--help|help) show_usage ;;
  *)
    echo "Unknown command: $1" >&2
    show_usage
    exit 1
    ;;
esac
